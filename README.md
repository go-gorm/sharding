# Gorm Sharding

[![Go](https://github.com/longbridgeapp/gorm-sharding/actions/workflows/go.yml/badge.svg)](https://github.com/longbridgeapp/gorm-sharding/actions/workflows/go.yml)
[![GoDoc](https://godoc.org/github.com/longbridgeapp/gorm-sharding?status.svg)](https://godoc.org/github.com/longbridgeapp/gorm-sharding)

English | [简体中文](./README.zh-CN.md)

Gorm Sharding plugin using SQL parser and replace for splits large tables into smaller ones, redirects Query into sharding tables. Give you a high performance database access.

Gorm Sharding 是一个业务污染小，高性能的数据库分表方案。通过 SQL 解析和替换，实现分表逻辑，让查询正确的根据规则执行到分表里面。

[![](https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbm5hbWUoKOWbviBBMSkpXG5maXJzdChcIui-k-WFpSBTUUwg6K-t5Y-lPGJyPlxuc3FsID0gc2VsZWN0ICogZnJvbSBvcmRlcnM8YnI-XG53aGVyZSB1c2VyX2lkID0gPyBhbmQgc3RhdHVzID0gPzxicj5cbmxpbWl0IDEwIG9yZGVyIGJ5IGlkIGRlc2M8YnI-XG5hcmdzID0gWzEwMCwgMV1cIilcblxuZmlyc3QtLS0-fCDosIPnlKggR29ybSDmn6Xor6IgfGRiW1wiR29ybSBEQlwiXVxuXG5zdWJncmFwaCBcIkdvcm0g5bGCXCJcbiAgZGItLT5nb3JtX3F1ZXJ5XG4gIGdvcm1fcXVlcnlbXCJjb25uUG9vbC5RdWVyeUNvbnRleHQoc3FsLCBhcmdzKTxicj5cIl1cbmVuZFxuXG5zdWJncmFwaCBcIkdvIOivreiogCBkYXRhYmFzZS9zcWwg55qEIENvbm4g5bGCXCJcbiAgRXhlY0NvbnRleHRbL1wiRXhlY0NvbnRleHRcIi9dXG4gIFF1ZXJ5Q29udGV4dFsvXCJRdWVyeUNvbnRleHRcIi9dXG4gIFF1ZXJ5Um93Q29udGV4dFsvXCJRdWVyeVJvd0NvbnRleHRcIi9dXG4gIGdvcm1fcXVlcnktLT5Db25uXG4gIENvbm4oW1wiQ29ublwiXSlcbiAgQ29ubi0tPkV4ZWNDb250ZXh0XG4gIENvbm4tLT5RdWVyeUNvbnRleHRcbiAgQ29ubi0tPlF1ZXJ5Um93Q29udGV4dFxuZW5kXG5cbnN1YmdyYXBoIHNoYXJkaW5nIFtcIk15Q29ublBvb2xcIl1cbiAgUXVlcnlDb250ZXh0LS0-cm91dGVyLS0-Zm9ybWF0X3NxbC0tPnBhcnNlLS0-Y2hlY2tfdGFibGVcbiAgcm91dGVyW1tcIuiwg-eUqCByb3V0ZXIg5Ye95pWw5aSE55CG5YiG6KGo6YC76L6RPGJyPnJvdXRlcihzcWwsIGFyZ3MpPGJyPjxicj7or6bop4HvvJrlm74gQjNcIl1dXG4gIGZvcm1hdF9zcWw-XCLlsIYgc3FsIOWSjCBhcmdzIOe7hOijheiOt-W-l-WujOaVtCBTUUw8YnI-PGJyPlxuICAgIHNxbCA9IHNlbGVjdCAqIGZyb20gb3JkZXJzPGJyPlxuICAgIHdoZXJlIHVzZXJfaWQgPSAxMDAgYW5kIHN0YXR1cyA9IDE8YnI-XG4gICAgbGltaXQgMTAgb3JkZXIgYnkgaWQgZGVzY1wiXVxuXG4gIGNoZWNrX3RhYmxle1wiYXN0LlRhYmxlTmFtZTxicj7mmK_lkKblrprkuYnliIbooajop4TliJlcIn1cbiAgY2hlY2tfdGFibGUtLT58IOaYryB8cHJvY2Vzc19hc3RcbiAgY2hlY2tfdGFibGVfMXt7XCLkuI3lpITnkIY8YnI-6L-U5Zue5Y6f5aeLIFNRTFwifX1cbiAgbm90X21hdGNoX2Vycm9yWy9cIui_lOWbnumUmeivrzxicj7opoHmsYLmn6Xor6Llv4XpobvluKbliIbooajplK5cIlxcXVxuXG4gIHBhcnNlW1tcIlNRTCBQYXJzZXIg6Kej5p6QIFNRTCDor63lj6XvvIzojrflvpcgYXN0IOagkeW9ouWvueixoTxicj5cbiAgPGJyPlxuICBhc3QgPSBzcWxwYXJzZXIuUGFyc2Uoc3FsKVwiXV1cblxuICBjaGVja190YWJsZS0uLT58IOWQpiB8Y2hlY2tfdGFibGVfMVxuICBwcm9jZXNzX2FzdCgoXCLpgY3ljoYgYXN0IOiKgueCue-8jOWvu-aJviBXaGVyZUNvbHVtbiDlrZfmrrU8YnI-XG7lubbljLnphY0gcmVzb2x2ZXIg5a6a5LmJ55qE5YiG6KGo6ZSuIFNoYXJkaW5nS2V5PGJyPjxicj5cbuWPguinge-8muWbviBCMlwiKSlcbiAgZ2V0X25ld190YWJsZV9uYW1lW1tcIueUqCBXaGVyZVZhbHVlIOeahOWAvCAxMDAg6K6h566X5YiG6KGo5bqP5Y-3PGJyPm9yZGVycyArICgxMDAgJSAxNik8YnI-5YiG6KGo5ZCN56ewID0gb3JkZXJzXzRcIl1dXG4gIG5ld19zcWx7e1wic2VsZWN0ICogZnJvbSBvcmRlcnNfNDxicj53aGVyZSB1c2VyX2lkID0gMTAwIGFuZCBzdGF0dXMgPSAxPGJyPmxpbWl0IDEwIG9yZGVyIGJ5IGlkIGRlc2NcIn19XG5cbiAgcHJvY2Vzc19hc3QtLi0-fCDmnKrmib7liLAgU2hhcmRpbmdLZXkgfG5vdF9tYXRjaF9lcnJvclxuICBwcm9jZXNzX2FzdC0tPnwg5ZG95LitIFNoYXJkaW5nS2V5IHxtYXRjaF9zaGFyZGluZ19rZXktLT58IOiOt-WPluWIhuihqOWQjeensCB8Z2V0X25ld190YWJsZV9uYW1lLS0-fCDmm7_mjaIgVGFibGVOYW1lIOiOt-W-l-aWsCBTUUwgfG5ld19zcWxcbmVuZFxuXG5cbnN1YmdyYXBoIGRhdGFiYXNlIFvmlbDmja7lupPlsYJdXG4gIHBvc3RzX290aGVyWyhcIm9yZGVyc18wLCBvcmRlcnNfMSAuLi4gb3JkZXJzXzNcIildXG4gIHBvc3RzXzRbKG9yZGVyc180KV1cbiAgcG9zdHNfbGFzdFsoXCJvcmRlcnNfNSAuLi4gb3JkZXJzXzE1XCIpXVxuICBvdGhlcl90YWJsZXNbKOWFtuS7luayoeacieWIhuihqOeahCBUYWJsZTxicj51c2Vycywgc3RvY2tzLCB0b3BpY3MgLi4uKV1cblxuICBuZXdfc3FsLS0-fCDliIbooajnmoTmn6Xor6IgfCBvcmRlcnNfNFxuICBjaGVja190YWJsZV8xLS4tPnwg5pyq5YiG6KGo55qE5p-l6K-iIHxvdGhlcl90YWJsZXNcbmVuZFxuXG5wb3N0c180LS0-cmVzdWx0XG5vdGhlcl90YWJsZXMtLi0-cmVzdWx0XG5yZXN1bHRbL-i_lOWbnuafpeivoue7k-aenFxcXSIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjpmYWxzZX0)](https://mermaid.live/edit#eyJjb2RlIjoiZ3JhcGggVERcbm5hbWUoKOWbviBBMSkpXG5maXJzdChcIui-k-WFpSBTUUwg6K-t5Y-lPGJyPlxuc3FsID0gc2VsZWN0ICogZnJvbSBvcmRlcnM8YnI-XG53aGVyZSB1c2VyX2lkID0gPyBhbmQgc3RhdHVzID0gPzxicj5cbmxpbWl0IDEwIG9yZGVyIGJ5IGlkIGRlc2M8YnI-XG5hcmdzID0gWzEwMCwgMV1cIilcblxuZmlyc3QtLS0-fCDosIPnlKggR29ybSDmn6Xor6IgfGRiW1wiR29ybSBEQlwiXVxuXG5zdWJncmFwaCBcIkdvcm0g5bGCXCJcbiAgZGItLT5nb3JtX3F1ZXJ5XG4gIGdvcm1fcXVlcnlbXCJjb25uUG9vbC5RdWVyeUNvbnRleHQoc3FsLCBhcmdzKTxicj5cIl1cbmVuZFxuXG5zdWJncmFwaCBcIkdvIOivreiogCBkYXRhYmFzZS9zcWwg55qEIENvbm4g5bGCXCJcbiAgRXhlY0NvbnRleHRbL1wiRXhlY0NvbnRleHRcIi9dXG4gIFF1ZXJ5Q29udGV4dFsvXCJRdWVyeUNvbnRleHRcIi9dXG4gIFF1ZXJ5Um93Q29udGV4dFsvXCJRdWVyeVJvd0NvbnRleHRcIi9dXG4gIGdvcm1fcXVlcnktLT5Db25uXG4gIENvbm4oW1wiQ29ublwiXSlcbiAgQ29ubi0tPkV4ZWNDb250ZXh0XG4gIENvbm4tLT5RdWVyeUNvbnRleHRcbiAgQ29ubi0tPlF1ZXJ5Um93Q29udGV4dFxuZW5kXG5cbnN1YmdyYXBoIHNoYXJkaW5nIFtcIk15Q29ublBvb2xcIl1cbiAgUXVlcnlDb250ZXh0LS0-cm91dGVyLS0-Zm9ybWF0X3NxbC0tPnBhcnNlLS0-Y2hlY2tfdGFibGVcbiAgcm91dGVyW1tcIuiwg-eUqCByb3V0ZXIg5Ye95pWw5aSE55CG5YiG6KGo6YC76L6RPGJyPnJvdXRlcihzcWwsIGFyZ3MpPGJyPjxicj7or6bop4HvvJrlm74gQjNcIl1dXG4gIGZvcm1hdF9zcWw-XCLlsIYgc3FsIOWSjCBhcmdzIOe7hOijheiOt-W-l-WujOaVtCBTUUw8YnI-PGJyPlxuICAgIHNxbCA9IHNlbGVjdCAqIGZyb20gb3JkZXJzPGJyPlxuICAgIHdoZXJlIHVzZXJfaWQgPSAxMDAgYW5kIHN0YXR1cyA9IDE8YnI-XG4gICAgbGltaXQgMTAgb3JkZXIgYnkgaWQgZGVzY1wiXVxuXG4gIGNoZWNrX3RhYmxle1wiYXN0LlRhYmxlTmFtZTxicj7mmK_lkKblrprkuYnliIbooajop4TliJlcIn1cbiAgY2hlY2tfdGFibGUtLT58IOaYryB8cHJvY2Vzc19hc3RcbiAgY2hlY2tfdGFibGVfMXt7XCLkuI3lpITnkIY8YnI-6L-U5Zue5Y6f5aeLIFNRTFwifX1cbiAgbm90X21hdGNoX2Vycm9yWy9cIui_lOWbnumUmeivrzxicj7opoHmsYLmn6Xor6Llv4XpobvluKbliIbooajplK5cIlxcXVxuXG4gIHBhcnNlW1tcIlNRTCBQYXJzZXIg6Kej5p6QIFNRTCDor63lj6XvvIzojrflvpcgYXN0IOagkeW9ouWvueixoTxicj5cbiAgPGJyPlxuICBhc3QgPSBzcWxwYXJzZXIuUGFyc2Uoc3FsKVwiXV1cblxuICBjaGVja190YWJsZS0uLT58IOWQpiB8Y2hlY2tfdGFibGVfMVxuICBwcm9jZXNzX2FzdCgoXCLpgY3ljoYgYXN0IOiKgueCue-8jOWvu-aJviBXaGVyZUNvbHVtbiDlrZfmrrU8YnI-XG7lubbljLnphY0gcmVzb2x2ZXIg5a6a5LmJ55qE5YiG6KGo6ZSuIFNoYXJkaW5nS2V5PGJyPjxicj5cbuWPguinge-8muWbviBCMlwiKSlcbiAgZ2V0X25ld190YWJsZV9uYW1lW1tcIueUqCBXaGVyZVZhbHVlIOeahOWAvCAxMDAg6K6h566X5YiG6KGo5bqP5Y-3PGJyPm9yZGVycyArICgxMDAgJSAxNik8YnI-5YiG6KGo5ZCN56ewID0gb3JkZXJzXzRcIl1dXG4gIG5ld19zcWx7e1wic2VsZWN0ICogZnJvbSBvcmRlcnNfNDxicj53aGVyZSB1c2VyX2lkID0gMTAwIGFuZCBzdGF0dXMgPSAxPGJyPmxpbWl0IDEwIG9yZGVyIGJ5IGlkIGRlc2NcIn19XG5cbiAgcHJvY2Vzc19hc3QtLi0-fCDmnKrmib7liLAgU2hhcmRpbmdLZXkgfG5vdF9tYXRjaF9lcnJvclxuICBwcm9jZXNzX2FzdC0tPnwg5ZG95LitIFNoYXJkaW5nS2V5IHxtYXRjaF9zaGFyZGluZ19rZXktLT58IOiOt-WPluWIhuihqOWQjeensCB8Z2V0X25ld190YWJsZV9uYW1lLS0-fCDmm7_mjaIgVGFibGVOYW1lIOiOt-W-l-aWsCBTUUwgfG5ld19zcWxcbmVuZFxuXG5cbnN1YmdyYXBoIGRhdGFiYXNlIFvmlbDmja7lupPlsYJdXG4gIHBvc3RzX290aGVyWyhcIm9yZGVyc18wLCBvcmRlcnNfMSAuLi4gb3JkZXJzXzNcIildXG4gIHBvc3RzXzRbKG9yZGVyc180KV1cbiAgcG9zdHNfbGFzdFsoXCJvcmRlcnNfNSAuLi4gb3JkZXJzXzE1XCIpXVxuICBvdGhlcl90YWJsZXNbKOWFtuS7luayoeacieWIhuihqOeahCBUYWJsZTxicj51c2Vycywgc3RvY2tzLCB0b3BpY3MgLi4uKV1cblxuICBuZXdfc3FsLS0-fCDliIbooajnmoTmn6Xor6IgfCBvcmRlcnNfNFxuICBjaGVja190YWJsZV8xLS4tPnwg5pyq5YiG6KGo55qE5p-l6K-iIHxvdGhlcl90YWJsZXNcbmVuZFxuXG5wb3N0c180LS0-cmVzdWx0XG5vdGhlcl90YWJsZXMtLi0-cmVzdWx0XG5yZXN1bHRbL-i_lOWbnuafpeivoue7k-aenFxcXSIsIm1lcm1haWQiOiJ7XG4gIFwidGhlbWVcIjogXCJkZWZhdWx0XCJcbn0iLCJ1cGRhdGVFZGl0b3IiOmZhbHNlLCJhdXRvU3luYyI6dHJ1ZSwidXBkYXRlRGlhZ3JhbSI6ZmFsc2V9)

## Features

- Non-intrusive design. Load the plugin, specify the config, and all done.
- Lighting-fast. No network based middlewares, as fast as Go.
- Multiple database support. PostgreSQL tested, MySQL and SQLite is coming.
- Allows you custom the Primary Key generator (Sequence, UUID, Snowflake ...).

## Install

```bash
go get -u github.com/longbridgeapp/gorm-sharding
```

## Usage

After the database connection opened, use the sharding plugin that registered the tables which you want to shard.

The `Register` function takes a map, the key is the **original table name** and the value is a **resolver** which is composed by five configurable fields.

For config detail info, see [Godoc](https://pkg.go.dev/github.com/longbridge/gorm-sharding).

## Usage Example

```go
middleware := sharding.Register(map[string]sharding.Resolver{
	"orders": {
		EnableFullTable: true,
		ShardingColumn: "user_id",
		ShardingAlgorithm: func(value interface{}) (suffix string, err error) {
			switch user_id := value.(type) {
			case int64:
				return fmt.Sprintf("_%02d", user_id % 64), nil
			default:
				return "", errors.New("invalid user_id")
			}
		},
		ShardingAlgorithmByPrimaryKey: func(id int64) (suffix string) {
			return fmt.Sprintf("_%02d", keygen.TableIdx(id))
		},
		PrimaryKeyGenerate: func(tableIdx int64) int64 {
			keygen.Snowflake()
			keygen.UUID(),
			keygen.Sequence("orders_id_seq"),
		}
	},
})
db.Use(middleware)
```

## License

This project under MIT license.
