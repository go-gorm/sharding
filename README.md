# Gorm Sharding

[![Go](https://github.com/longbridgeapp/gorm-sharding/actions/workflows/go.yml/badge.svg)](https://github.com/longbridgeapp/gorm-sharding/actions/workflows/go.yml)
[![GoDoc](https://godoc.org/github.com/longbridgeapp/gorm-sharding?status.svg)](https://godoc.org/github.com/longbridgeapp/gorm-sharding)

English | [简体中文](./README.zh-CN.md)

Gorm Sharding plugin using SQL parser and replace for splits large tables into smaller ones, redirects Query into sharding tables. Give you a high performance database access.

Gorm Sharding 是一个业务污染小，高性能的数据库分表方案。通过 SQL 解析和替换，实现分表逻辑，让查询正确的根据规则执行到分表里面。

[![](https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbmZpcnN0KFwiU1FMIFF1ZXJ5PGJyPjxicj5cbnNlbGVjdCAqIGZyb20gb3JkZXJzPGJyPlxud2hlcmUgdXNlcl9pZCA9ID8gYW5kIHN0YXR1cyA9ID88YnI-XG5saW1pdCAxMCBvcmRlciBieSBpZCBkZXNjPGJyPlxuYXJncyA9IFsxMDAsIDFdXCIpXG5cbmZpcnN0LS0tPnwgR29ybSBRdWVyeSB8ZGJbXCJHb3JtIERCXCJdXG5cbnN1YmdyYXBoIFwiR29ybVwiXG4gIGRiLS0-Z29ybV9xdWVyeVxuICBnb3JtX3F1ZXJ5W1wiY29ublBvb2wuUXVlcnlDb250ZXh0KHNxbCwgYXJncyk8YnI-XCJdXG5lbmRcblxuc3ViZ3JhcGggXCJkYXRhYmFzZS9zcWwgLSBDb25uXCJcbiAgRXhlY0NvbnRleHRbL1wiRXhlY0NvbnRleHRcIi9dXG4gIFF1ZXJ5Q29udGV4dFsvXCJRdWVyeUNvbnRleHRcIi9dXG4gIFF1ZXJ5Um93Q29udGV4dFsvXCJRdWVyeVJvd0NvbnRleHRcIi9dXG4gIGdvcm1fcXVlcnktLT5Db25uXG4gIENvbm4oW1wiQ29ublwiXSlcbiAgQ29ubi0tPkV4ZWNDb250ZXh0XG4gIENvbm4tLT5RdWVyeUNvbnRleHRcbiAgQ29ubi0tPlF1ZXJ5Um93Q29udGV4dFxuZW5kXG5cbnN1YmdyYXBoIHNoYXJkaW5nIFtcIk15Q29ublBvb2xcIl1cbiAgUXVlcnlDb250ZXh0LS0-cm91dGVyLS0-Zm9ybWF0X3NxbC0tPnBhcnNlLS0-Y2hlY2tfdGFibGVcbiAgcm91dGVyW1tcInJvdXRlcihzcWwsIGFyZ3MpPGJyPjxicj5cIl1dXG4gIGZvcm1hdF9zcWw-XCJGb3JtYXQgc3FsLCBhcmdzIGZvciBnZXQgZnVsbCBTUUw8YnI-PGJyPlxuICAgIHNxbCA9IHNlbGVjdCAqIGZyb20gb3JkZXJzPGJyPlxuICAgIHdoZXJlIHVzZXJfaWQgPSAxMDAgYW5kIHN0YXR1cyA9IDE8YnI-XG4gICAgbGltaXQgMTAgb3JkZXIgYnkgaWQgZGVzY1wiXVxuXG4gIGNoZWNrX3RhYmxle1wiQ2hlY2sgc2hhcmRpbmcgcnVsZXM8YnI-YnkgdGFibGUgbmFtZVwifVxuICBjaGVja190YWJsZS0tPnwgRXhpc3QgfHByb2Nlc3NfYXN0XG4gIGNoZWNrX3RhYmxlXzF7e1wiUmV0dXJuIFJhdyBTUUxcIn19XG4gIG5vdF9tYXRjaF9lcnJvclsvXCJSZXR1cm4gRXJyb3I8YnI-U1FMIHF1ZXJ5IG11c3QgaGFzIHNoYXJkaW5nIGtleVwiXFxdXG5cbiAgcGFyc2VbW1wiUGFyc2VyIFNRTCB0byBnZXQgQVNUPGJyPlxuICA8YnI-XG4gIGFzdCA9IHNxbHBhcnNlci5QYXJzZShzcWwpXCJdXVxuXG4gIGNoZWNrX3RhYmxlLS4tPnwgTm90IGV4aXN0IHxjaGVja190YWJsZV8xXG4gIHByb2Nlc3NfYXN0KChcIlNoYXJkaW5nIHJ1bGVzXCIpKVxuICBnZXRfbmV3X3RhYmxlX25hbWVbW1wiVXNlIHZhbHVlIGluIFdoZXJlVmFsdWUgKDEwMCkgZm9yIGdldCBzaGFyZGluZyB0YWJsZSBpbmRleDxicj5vcmRlcnMgKyAoMTAwICUgMTYpPGJyPlNoYXJkaW5nIFRhYmxlID0gb3JkZXJzXzRcIl1dXG4gIG5ld19zcWx7e1wic2VsZWN0ICogZnJvbSBvcmRlcnNfNDxicj53aGVyZSB1c2VyX2lkID0gMTAwIGFuZCBzdGF0dXMgPSAxPGJyPmxpbWl0IDEwIG9yZGVyIGJ5IGlkIGRlc2NcIn19XG5cbiAgcHJvY2Vzc19hc3QtLi0-fCBOb3QgbWF0Y2ggU2hhcmRpbmdLZXkgfG5vdF9tYXRjaF9lcnJvclxuICBwcm9jZXNzX2FzdC0tPnwgTWF0Y2ggU2hhcmRpbmdLZXkgfG1hdGNoX3NoYXJkaW5nX2tleS0tPnwgR2V0IHRhYmxlIG5hbWUgfGdldF9uZXdfdGFibGVfbmFtZS0tPnwgUmVwbGFjZSBUYWJsZU5hbWUgdG8gZ2V0IG5ldyBTUUwgfG5ld19zcWxcbmVuZFxuXG5cbnN1YmdyYXBoIGRhdGFiYXNlIFtEYXRhYmFzZV1cbiAgcG9zdHNfb3RoZXJbKFwib3JkZXJzXzAsIG9yZGVyc18xIC4uLiBvcmRlcnNfM1wiKV1cbiAgcG9zdHNfNFsob3JkZXJzXzQpXVxuICBwb3N0c19sYXN0WyhcIm9yZGVyc181IC4uLiBvcmRlcnNfMTVcIildXG4gIG90aGVyX3RhYmxlc1soT3RoZXIgbm9uLXNoYXJkaW5nIHRhYmxlczxicj51c2Vycywgc3RvY2tzLCB0b3BpY3MgLi4uKV1cblxuICBuZXdfc3FsLS0-fCBTaGFyZGluZyBRdWVyeSB8IG9yZGVyc180XG4gIGNoZWNrX3RhYmxlXzEtLi0-fCBOb25lIHNoYXJkaW5nIFF1ZXJ5IHxvdGhlcl90YWJsZXNcbmVuZFxuXG5wb3N0c180LS0-cmVzdWx0XG5vdGhlcl90YWJsZXMtLi0-cmVzdWx0XG5yZXN1bHRbL1F1ZXJ5IHJlc3VsdHNcXF0iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlLCJhdXRvU3luYyI6dHJ1ZSwidXBkYXRlRGlhZ3JhbSI6ZmFsc2V9)](https://mermaid.live/edit#eyJjb2RlIjoiZ3JhcGggVERcbmZpcnN0KFwiU1FMIFF1ZXJ5PGJyPjxicj5cbnNlbGVjdCAqIGZyb20gb3JkZXJzPGJyPlxud2hlcmUgdXNlcl9pZCA9ID8gYW5kIHN0YXR1cyA9ID88YnI-XG5saW1pdCAxMCBvcmRlciBieSBpZCBkZXNjPGJyPlxuYXJncyA9IFsxMDAsIDFdXCIpXG5cbmZpcnN0LS0tPnwgR29ybSBRdWVyeSB8ZGJbXCJHb3JtIERCXCJdXG5cbnN1YmdyYXBoIFwiR29ybVwiXG4gIGRiLS0-Z29ybV9xdWVyeVxuICBnb3JtX3F1ZXJ5W1wiY29ublBvb2wuUXVlcnlDb250ZXh0KHNxbCwgYXJncyk8YnI-XCJdXG5lbmRcblxuc3ViZ3JhcGggXCJkYXRhYmFzZS9zcWwgLSBDb25uXCJcbiAgRXhlY0NvbnRleHRbL1wiRXhlY0NvbnRleHRcIi9dXG4gIFF1ZXJ5Q29udGV4dFsvXCJRdWVyeUNvbnRleHRcIi9dXG4gIFF1ZXJ5Um93Q29udGV4dFsvXCJRdWVyeVJvd0NvbnRleHRcIi9dXG4gIGdvcm1fcXVlcnktLT5Db25uXG4gIENvbm4oW1wiQ29ublwiXSlcbiAgQ29ubi0tPkV4ZWNDb250ZXh0XG4gIENvbm4tLT5RdWVyeUNvbnRleHRcbiAgQ29ubi0tPlF1ZXJ5Um93Q29udGV4dFxuZW5kXG5cbnN1YmdyYXBoIHNoYXJkaW5nIFtcIk15Q29ublBvb2xcIl1cbiAgUXVlcnlDb250ZXh0LS0-cm91dGVyLS0-Zm9ybWF0X3NxbC0tPnBhcnNlLS0-Y2hlY2tfdGFibGVcbiAgcm91dGVyW1tcInJvdXRlcihzcWwsIGFyZ3MpPGJyPjxicj5cIl1dXG4gIGZvcm1hdF9zcWw-XCJGb3JtYXQgc3FsLCBhcmdzIGZvciBnZXQgZnVsbCBTUUw8YnI-PGJyPlxuICAgIHNxbCA9IHNlbGVjdCAqIGZyb20gb3JkZXJzPGJyPlxuICAgIHdoZXJlIHVzZXJfaWQgPSAxMDAgYW5kIHN0YXR1cyA9IDE8YnI-XG4gICAgbGltaXQgMTAgb3JkZXIgYnkgaWQgZGVzY1wiXVxuXG4gIGNoZWNrX3RhYmxle1wiQ2hlY2sgc2hhcmRpbmcgcnVsZXM8YnI-YnkgdGFibGUgbmFtZVwifVxuICBjaGVja190YWJsZS0tPnwgRXhpc3QgfHByb2Nlc3NfYXN0XG4gIGNoZWNrX3RhYmxlXzF7e1wiUmV0dXJuIFJhdyBTUUxcIn19XG4gIG5vdF9tYXRjaF9lcnJvclsvXCJSZXR1cm4gRXJyb3I8YnI-U1FMIHF1ZXJ5IG11c3QgaGFzIHNoYXJkaW5nIGtleVwiXFxdXG5cbiAgcGFyc2VbW1wiUGFyc2VyIFNRTCB0byBnZXQgQVNUPGJyPlxuICA8YnI-XG4gIGFzdCA9IHNxbHBhcnNlci5QYXJzZShzcWwpXCJdXVxuXG4gIGNoZWNrX3RhYmxlLS4tPnwgTm90IGV4aXN0IHxjaGVja190YWJsZV8xXG4gIHByb2Nlc3NfYXN0KChcIlNoYXJkaW5nIHJ1bGVzXCIpKVxuICBnZXRfbmV3X3RhYmxlX25hbWVbW1wiVXNlIHZhbHVlIGluIFdoZXJlVmFsdWUgKDEwMCkgZm9yIGdldCBzaGFyZGluZyB0YWJsZSBpbmRleDxicj5vcmRlcnMgKyAoMTAwICUgMTYpPGJyPlNoYXJkaW5nIFRhYmxlID0gb3JkZXJzXzRcIl1dXG4gIG5ld19zcWx7e1wic2VsZWN0ICogZnJvbSBvcmRlcnNfNDxicj53aGVyZSB1c2VyX2lkID0gMTAwIGFuZCBzdGF0dXMgPSAxPGJyPmxpbWl0IDEwIG9yZGVyIGJ5IGlkIGRlc2NcIn19XG5cbiAgcHJvY2Vzc19hc3QtLi0-fCBOb3QgbWF0Y2ggU2hhcmRpbmdLZXkgfG5vdF9tYXRjaF9lcnJvclxuICBwcm9jZXNzX2FzdC0tPnwgTWF0Y2ggU2hhcmRpbmdLZXkgfG1hdGNoX3NoYXJkaW5nX2tleS0tPnwgR2V0IHRhYmxlIG5hbWUgfGdldF9uZXdfdGFibGVfbmFtZS0tPnwgUmVwbGFjZSBUYWJsZU5hbWUgdG8gZ2V0IG5ldyBTUUwgfG5ld19zcWxcbmVuZFxuXG5cbnN1YmdyYXBoIGRhdGFiYXNlIFtEYXRhYmFzZV1cbiAgcG9zdHNfb3RoZXJbKFwib3JkZXJzXzAsIG9yZGVyc18xIC4uLiBvcmRlcnNfM1wiKV1cbiAgcG9zdHNfNFsob3JkZXJzXzQpXVxuICBwb3N0c19sYXN0WyhcIm9yZGVyc181IC4uLiBvcmRlcnNfMTVcIildXG4gIG90aGVyX3RhYmxlc1soT3RoZXIgbm9uLXNoYXJkaW5nIHRhYmxlczxicj51c2Vycywgc3RvY2tzLCB0b3BpY3MgLi4uKV1cblxuICBuZXdfc3FsLS0-fCBTaGFyZGluZyBRdWVyeSB8IG9yZGVyc180XG4gIGNoZWNrX3RhYmxlXzEtLi0-fCBOb25lIHNoYXJkaW5nIFF1ZXJ5IHxvdGhlcl90YWJsZXNcbmVuZFxuXG5wb3N0c180LS0-cmVzdWx0XG5vdGhlcl90YWJsZXMtLi0-cmVzdWx0XG5yZXN1bHRbL1F1ZXJ5IHJlc3VsdHNcXF0iLCJtZXJtYWlkIjoie1xuICBcInRoZW1lXCI6IFwiZGVmYXVsdFwiXG59IiwidXBkYXRlRWRpdG9yIjpmYWxzZSwiYXV0b1N5bmMiOnRydWUsInVwZGF0ZURpYWdyYW0iOmZhbHNlfQ)

## Features

- Non-intrusive design. Load the plugin, specify the config, and all done.
- Lighting-fast. No network based middlewares, as fast as Go.
- Multiple database support. PostgreSQL tested, MySQL and SQLite is coming.
- Allows you custom the Primary Key generator (Sequence, UUID, Snowflake ...).

## Install

```bash
go get -u github.com/longbridgeapp/gorm-sharding
```

## Usage

After the database connection opened, use the sharding plugin that registered the tables which you want to shard.

The `Register` function takes a map, the key is the **original table name** and the value is a **resolver** which is composed by five configurable fields.

For config detail info, see [Godoc](https://pkg.go.dev/github.com/longbridge/gorm-sharding).

## Usage Example

```go
middleware := sharding.Register(map[string]sharding.Resolver{
	"orders": {
		EnableFullTable: true,
		ShardingColumn: "user_id",
		ShardingAlgorithm: func(value interface{}) (suffix string, err error) {
			switch user_id := value.(type) {
			case int64:
				return fmt.Sprintf("_%02d", user_id % 64), nil
			default:
				return "", errors.New("invalid user_id")
			}
		},
		ShardingAlgorithmByPrimaryKey: func(id int64) (suffix string) {
			return fmt.Sprintf("_%02d", keygen.TableIdx(id))
		},
		PrimaryKeyGenerate: func(tableIdx int64) int64 {
			keygen.Snowflake()
			keygen.UUID(),
			keygen.Sequence("orders_id_seq"),
		}
	},
})
db.Use(middleware)
```

## License

This project under MIT license.
